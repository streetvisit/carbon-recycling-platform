# Fixes Applied - January 25, 2025

## Summary
Fixed multiple critical issues related to Clerk authentication and JavaScript module imports that were preventing the site from functioning properly in production.

---

## Issues Fixed

### 1. ✅ Module Import Errors - "Failed to resolve module specifier"

**Problem**: Browser couldn't resolve bare module specifiers like `'preact'`, `'@clerk/clerk-js'` in inline scripts.

**Root Cause**: Inline `<script type="module">` tags with bare imports aren't processed by Vite's bundler during build.

**Solution**:
- **Dashboard page**: Extracted inline Preact logic into proper `SupplierPortalApp.tsx` component
- **Sign-in page**: Replaced manual `@clerk/clerk-js` import with `<SignIn />` Astro component  
- **Sign-up page**: Replaced manual `@clerk/clerk-js` import with `<SignUp />` Astro component

**Files Changed**:
- Created: `apps/web/src/components/SupplierPortalApp.tsx`
- Modified: `apps/web/src/pages/portal/dashboard.astro`
- Modified: `apps/web/src/pages/sign-in.astro`
- Modified: `apps/web/src/pages/sign-up.astro`

**Commits**:
- `8648798` - fix: Clerk sign-in/sign-up module import error
- `0fa7a2b` - fix: Preact module import error on dashboard
- `f6ae46d` - fix: Use Clerk Astro components instead of manual imports

---

### 2. ✅ Clerk Development Keys Warning in Production

**Problem**: Site was using test keys (`pk_test_*`) in production despite having live keys set in Cloudflare Pages.

**Root Cause**: `astro.config.mjs` had default fallback values with test keys. When environment variables weren't read properly, Astro used these defaults.

**Solution**:
- Removed `default` values from Clerk key definitions in `astro.config.mjs`
- Set `optional: false` to make keys required for builds
- Now builds will fail if keys aren't properly set (better than silently using test keys)

**Files Changed**:
- Modified: `apps/web/astro.config.mjs`
- Modified: `apps/web/.env` (added warning comment)

**Action Required**:
Ensure these environment variables are set in Cloudflare Pages dashboard:
- `PUBLIC_CLERK_PUBLISHABLE_KEY` = `pk_live_...` (your live publishable key)
- `CLERK_SECRET_KEY` = `sk_live_...` (your live secret key)

**Commit**: `402bcab` - fix: Remove Clerk test key defaults - require production keys

---

### 3. ✅ Clerk Deprecation Warnings

**Problem**: Console warnings about deprecated `afterSignInUrl` and `afterSignUpUrl` props.

**Solution**:
- Updated to new Clerk redirect API
- Replaced `afterSignInUrl` → `fallbackRedirectUrl`
- Replaced `afterSignUpUrl` → `fallbackRedirectUrl`
- Removed redundant redirect config from `clerk()` integration

**Files Changed**:
- Modified: `apps/web/src/pages/sign-in.astro`
- Modified: `apps/web/src/pages/sign-up.astro`
- Modified: `apps/web/astro.config.mjs`

**Commit**: `5362ff7` - fix: Update Clerk redirect props to new API

---

## Verification Checklist

After deployment completes, verify:

- [ ] No module import errors in browser console
- [ ] Sign-in page loads properly: https://carbonrecycling.co.uk/sign-in/
- [ ] Sign-up page loads properly: https://carbonrecycling.co.uk/sign-up/
- [ ] Dashboard loads properly: https://carbonrecycling.co.uk/portal/dashboard/
- [ ] No Clerk development key warnings (if Cloudflare env vars are set)
- [ ] No Clerk deprecation warnings about redirect props
- [ ] Authentication flow works end-to-end

---

## Technical Details

### Why Inline Scripts Don't Work in Astro Static Builds

When using `output: 'static'` in Astro:
1. All code is compiled at **build time**
2. Inline `<script type="module">` tags are copied as-is to the output
3. Bare module specifiers (e.g., `import { x } from 'package'`) aren't resolved
4. Browser tries to load them and fails

**Solution**: Use proper component files that Vite can process during build.

### Why Environment Variable Defaults Are Problematic

With static builds:
1. Environment variables are baked into the JavaScript at build time
2. Defaults in `astro.config.mjs` override missing environment variables
3. Even if Cloudflare sets env vars, defaults might be used instead
4. Result: Test keys in production

**Solution**: Remove defaults and make critical env vars required (`optional: false`).

---

## Related Documentation

- Clerk Astro Integration: https://clerk.com/docs/references/astro/overview
- Clerk Custom Redirects: https://clerk.com/docs/guides/custom-redirects
- Astro Environment Variables: https://docs.astro.build/en/guides/environment-variables/
- Vite Module Resolution: https://vitejs.dev/guide/dep-pre-bundling.html

---

## Future Improvements

1. **Consider SSR**: Switch from `output: 'static'` to `output: 'hybrid'` or `'server'` for dynamic environment variable loading
2. **Environment Variable Validation**: Add runtime checks for critical env vars
3. **Testing**: Add E2E tests for authentication flow
4. **Monitoring**: Set up alerts for authentication failures in production
